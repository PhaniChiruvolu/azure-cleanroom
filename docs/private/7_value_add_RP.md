# Value-Add RP

A general-purpose RP is not useful for deploying a Clean Room or translating a Clean Room specification into its corresponding confidential computation deployment template as discussed earlier. Similarly, a general-purpose RP is not useful for creating and managing a multi-tenant contract or governance service as discussed here.

However, a case can be made for a Clean Room RP providing customer value-add in the context of multi-party collaboration workflows, as a few aspects of the Preparation Stage lend themselves well for offloading to a Microsoft RP without compromising on zero-trust requirements through verifiable trust.

## Clean Room Governance Service Initialization

A Clean Room RP can deploy and manage the Clean Room Governance Service (CGS) as an mCCF application in a managed RG within the customer tenant. The CCF infrastructure, constitution and the CGS application are all open-sourced, and customers can readily validate that only the expected code is running before joining the consortium and participating in the collaboration. This allows for a mechanism where the entry barrier for customers to learn CCF is greatly lowered, while still providing a fully auditable and verifiable option for advanced customers without bringing the RP into the TCB.

```mermaid
sequenceDiagram
title Clean Room Governance Service - Initialization (RP Enabled)

actor ISV
actor CP
actor DP
participant RP
participant CCF
participant Constitution
participant CGS
participant KVS

rect Purple
note over ISV,KVS: Workspace Creation
    ISV->>+RP: PUT Workspace
rect Teal
note over RP,KVS: Consortium - Creation
    %% create participant CCF
    RP->>CCF:Create CCF
    %% create participant KVS
    CCF->>KVS:`
    CCF-->>RP:CCF created
    RP->>+CCF:Set constitution
    %% create participant Constitution
    CCF->>Constitution:`
    Constitution-->>CCF:`
    CCF-->>-RP:Constitution configured
    RP->>+CCF:Deploy CGS
    %% create participant CGS
    CCF->>CGS:Deploy App
    CGS-->>CCF:`
    CCF-->>-RP: App Configured
    RP->>+CCF: Add customer to consortium
    CCF-->>-RP: invitation
end
    RP-->>-ISV: invitation
    note over ISV: Validate Constitution
    note over ISV: Validate App
    ISV->>CCF: Accept invitation
end

rect Teal
note over ISV,CCF: Consortium - Establishing quorum
    ISV->>+CCF: Add collaborators to consortium
    CCF-->>-ISV: Invitations
    par parallel
        ISV->>+DP: Share invitation
        note over DP: Validate Constitution
        note over DP: Validate App
        DP->>+CCF: Accept invitation
        CCF-->>-DP:`
        DP-->>-ISV: Accepted 
    and
        ISV->>+CP: Share invitation
        note over CP: Validate Constitution
        note over CP: Validate App
        CP->>+CCF: Accept invitation
        CCF-->>-CP:`
        CP-->>-ISV: Accepted 
    end
end
```

Figure _RP Enabled Clean Room Governance Service Initialization_

## Pre-Provisioning Phase

The Clean Room RP translates a CGS backed Clean Room Specification into the corresponding deployment template and key release policies which are then proposed to the mCCF instance as “attachments” to the given specification. The template and key release policy are necessarily equivalent to those generated by executing the open-sourced Clean Room tooling. This allows for a mechanism where customers can directly consume the deployment template and key release policy proposed by the RP, while still providing a fully verifiable option for advanced customers without bringing the RP into the TCB.

```mermaid
sequenceDiagram
title Collaboration - Pre-Provisioning Phase (RP Enabled)

actor ISV
participant AD
participant RP
participant CCF
participant Constitution
participant CGS
participant KVS

rect Teal
note over ISV,KVS: Pre-Provisioning Phase
    ISV->>+RP: PUT Workspace/Specification
    
    RP->>+CGS: Contract/Fetch(id)
    CGS->>+KVS: kvs["accepted"].Get(id)
    KVS-->>-CGS: [spec, proposal_id]
    CGS-->>-RP: spec, state:"accepted", proposal_id
    
    note over RP: Generate deployment template
    note over RP: Generate key release policy

    RP->>+CCF: Propose(id, template, policy)
    CCF-->>+Constitution: CreateProposal(id, template, policy)
    note over Constitution: Auto resolve as proposer is RP
    Constitution->>+KVS: kvs["template"].Set\n(id, [template, policy, proposal_id])
    KVS-->>-Constitution: `
    Constitution-->>-CCF: `
    CCF-->>-RP: proposal_id

    RP-->>-ISV: `

    ISV->>+AD: Provision identity
    AD-->>-ISV: clean room identity
end
```

Figure RP Enabled Pre-Provisioning

## Resource Provision Phase

As part of the resource provision phase, data and code providers need to verify that the key release policy given by the solution provider corresponds to the agreed upon specification by executing the open-sourced Clean Room tooling again by themselves and comparing the two policies.
When the Clean Room RP proposes a key release policy to the mCCF as an “attachment” to the given specification, it allows for a mechanism where data and code providers can directly consume the key release policy proposed by the RP, while still providing a fully verifiable option for advanced customers without bringing the RP into the TCB.

```mermaid
%%{init: {'theme':'dark'}}%%
sequenceDiagram
title Collaboration - Resource Provisioning Phase (RP Enabled)

actor ISV as Solution Provider
actor CP as Code Provider
actor DP as Data Provider
participant CMS as CGS
participant Blob
participant mHSM
participant AKV
participant KVS

rect teal
note over ISV,KVS: Resource Provisioning Phase
    ISV->>+DP: Provision resources\n(clean room identity)
    ISV->>+CP: Provision resources\n(clean room identity)

    CP->>+CMS: Contract/GetKeyReleasePolicy(id)
    CMS->>+KVS: kvs["template"].Get(id)
    KVS-->>-CMS: [template, policy, proposal_id]
    CMS-->>-CP: policy

    DP->>+CMS: Contract/GetKeyReleasePolicy(id)
    CMS->>+KVS: kvs["template"].Get(id)
    KVS-->>-CMS: [template, policy, proposal_id]
    CMS-->>-DP: policy

    note over CP: Generate CodeKEK
    note over DP: Generate DataKEK
    CP->>+mHSM: Store(CodeKEK, key release policy, clean room identity)
    mHSM-->>-CP: `
    DP->>+mHSM: Store(DataKEK, key release policy, clean room identity)
    mHSM-->>-DP: `
    note over CP: Wrap CodeDEK
    CP->>+AKV: Store(Wrapped CodeDEK, clean room identity)
    AKV-->>-CP: `
    note over DP: Wrap DataDEK
    DP->>+AKV: Store(Wrapped DataDEK, clean room identity)
    AKV-->>-DP: `
    CP->>+Blob: Provision access to encrypted code (clean room identity)
    Blob-->>-CP: `
    CP-->>-ISV: `
    DP->>+Blob: Provision access to encrypted data (clean room identity)
    Blob-->>-DP: `
    DP-->>-ISV: `
end
```

Figure _RP Enabled Resource Provisioning*
